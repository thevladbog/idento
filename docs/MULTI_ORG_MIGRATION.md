# Multi-Organization Support Migration Guide

## Обзор изменений

Система теперь поддерживает участие одного пользователя в нескольких организациях (multi-tenancy). Основные изменения:

### Backend

1. **Новая миграция базы данных** (`009_multi_org_support.up.sql`)
   - Создана таблица `user_tenants` для связи many-to-many между пользователями и организациями
   - Добавлены новые поля в таблицу `tenants`: `settings`, `logo_url`, `website`, `contact_email`
   - Автоматическая миграция существующих связей пользователь-организация

2. **Обновленные модели**
   - `Tenant` - добавлены новые поля для настроек организации
   - `UserTenant` - новая модель для связи пользователя с организацией
   - `UserWithTenants` - модель для отображения пользователя со всеми его организациями

3. **Новые API endpoints**
   - `POST /api/auth/switch-tenant` - переключение между организациями
   - `GET /api/tenants` - список организаций текущего пользователя
   - `GET /api/tenants/:id` - информация об организации
   - `PUT /api/tenants/:id` - обновление информации об организации

4. **Обновленная аутентификация**
   - При логине/регистрации возвращается список всех организаций пользователя
   - JWT токен содержит ID текущей активной организации
   - Возможность переключения между организациями без повторного логина

### Frontend

1. **Обновленный Dashboard**
   - Новый современный дизайн с плитками одинаковой высоты
   - Использование Card компонентов из shadcn/ui
   - Иконки для каждой секции
   - Добавлена плитка для настроек организации

2. **Компонент переключения организаций**
   - `OrganizationSwitcher` - выпадающий список для переключения между организациями
   - Отображается в навигационной панели
   - Показывает роль пользователя в каждой организации
   - Автоматически скрывается, если у пользователя только одна организация

3. **Страница настроек организации**
   - `OrganizationSettings` - управление информацией об организации
   - Редактирование названия, веб-сайта, контактного email
   - Отображение роли пользователя и даты создания организации
   - Доступно только пользователям с правами администратора

4. **Обновленная локализация**
   - Добавлены переводы на английский и русский для всех новых элементов
   - Ключи для организаций, переключения, настроек

## Инструкции по развертыванию

### 1. Применение миграции базы данных

```bash
cd backend
# Миграция применится автоматически при запуске backend
# Или вручную выполните SQL из файла:
psql -U idento -d idento_db < migrations/009_multi_org_support.up.sql
```

### 2. Запуск backend

```bash
cd backend
go run main.go
```

Backend автоматически применит миграцию при старте.

### 3. Установка зависимостей frontend (если нужно)

```bash
cd web
npm install
```

### 4. Запуск frontend

```bash
cd web
npm run dev
```

## Использование

### Для пользователей

1. **Просмотр организаций**: 
   - После входа в навигационной панели отображается переключатель организаций (если у вас больше одной)

2. **Переключение организации**:
   - Кликните на название текущей организации
   - Выберите другую организацию из списка
   - Страница автоматически обновится с данными выбранной организации

3. **Настройки организации**:
   - Перейдите в Dashboard → Настройки организации
   - Доступно только администраторам организации
   - Можно изменить название, веб-сайт, контактный email

### Для разработчиков

#### Получение текущей организации на frontend

```typescript
const currentTenant = JSON.parse(localStorage.getItem('current_tenant') || 'null');
```

#### Получение списка всех организаций пользователя

```typescript
const response = await api.get('/api/tenants');
const tenants = response.data;
```

#### Переключение организации

```typescript
const response = await api.post('/api/auth/switch-tenant', {
  tenant_id: newTenantId
});
localStorage.setItem('token', response.data.token);
localStorage.setItem('current_tenant', JSON.stringify(response.data.current_tenant));
```

## Обратная совместимость

- Существующие пользователи автоматически привязываются к своим организациям через миграцию
- Старый код продолжит работать, так как поле `tenant_id` в таблице `users` сохранено
- JWT токены остаются совместимыми

## Откат изменений (если необходимо)

```bash
cd backend
psql -U idento -d idento_db < migrations/009_multi_org_support.down.sql
```

**Внимание**: Откат удалит таблицу `user_tenants` и дополнительные поля организаций!

## Тестирование

1. Зарегистрируйте нового пользователя - создастся новая организация
2. Проверьте, что пользователь может видеть и редактировать настройки организации
3. Добавьте пользователя в другую организацию через базу данных:
   ```sql
   INSERT INTO user_tenants (user_id, tenant_id, role)
   VALUES ('user-uuid', 'tenant-uuid', 'member');
   ```
4. Залогиньтесь снова и проверьте переключатель организаций

## Известные особенности

- Пользователь с одинаковым email может быть в нескольких организациях
- При логине автоматически выбирается первая организация из списка
- Роли пользователя могут отличаться в разных организациях
- Переключение организации требует обновления страницы для корректной загрузки данных

## Поддержка

При возникновении проблем проверьте:
1. Применена ли миграция базы данных
2. Обновлены ли зависимости frontend
3. Очищен ли кэш браузера (localStorage)
4. Логи backend на наличие ошибок


