name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

# Cancel in-progress runs for the same workflow and branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Detect which paths changed to optimize job execution
  changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      web: ${{ steps.filter.outputs.web }}
      mobile: ${{ steps.filter.outputs.mobile }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'agent/**'
              - 'go.work'
              - 'go.work.sum'
            web:
              - 'web/**'
            mobile:
              - 'mobile/**'

  # Lint Go code (backend + agent)
  lint-go:
    name: Lint Go (Backend & Agent)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: true
          cache-dependency-path: |
            backend/go.sum
            agent/go.sum
      
      # Use official golangci-lint action for better performance and caching
      - name: Lint backend
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          working-directory: backend
          args: --timeout=5m ./internal/...
      
      - name: Lint agent
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          working-directory: agent
          args: --timeout=5m ./...
      
      - name: Summary
        if: always()
        run: |
          echo "## Go Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Backend and Agent linting completed" >> $GITHUB_STEP_SUMMARY

  # Test Go code with coverage and race detection
  test-go:
    name: Test Go (Coverage & Race Detection)
    runs-on: ubuntu-latest
    needs: [changes, lint-go]
    if: needs.changes.outputs.backend == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: true
          cache-dependency-path: |
            backend/go.sum
            agent/go.sum
      
      - name: Test backend with coverage
        run: |
          cd backend
          go test -race -coverprofile=coverage.out -covermode=atomic ./...
          go tool cover -func=coverage.out
      
      - name: Test agent with coverage
        run: |
          cd agent
          go test -race -coverprofile=coverage.out -covermode=atomic ./...
          go tool cover -func=coverage.out
      
      - name: Upload backend coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage
          path: backend/coverage.out
          retention-days: 7
      
      - name: Upload agent coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: agent-coverage
          path: agent/coverage.out
          retention-days: 7
      
      - name: Summary
        if: always()
        run: |
          echo "## Go Test Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Tests completed with race detection" >> $GITHUB_STEP_SUMMARY
          if [ -f backend/coverage.out ]; then
            echo "### Backend Coverage" >> $GITHUB_STEP_SUMMARY
            go tool cover -func=backend/coverage.out | tail -1 >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f agent/coverage.out ]; then
            echo "### Agent Coverage" >> $GITHUB_STEP_SUMMARY
            go tool cover -func=agent/coverage.out | tail -1 >> $GITHUB_STEP_SUMMARY
          fi

  # Build Go binaries
  build-go:
    name: Build Go (Backend & Agent)
    runs-on: ubuntu-latest
    needs: [changes, test-go]
    if: needs.changes.outputs.backend == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: true
          cache-dependency-path: |
            backend/go.sum
            agent/go.sum
      
      - name: Build backend
        run: cd backend && go build -v -o /tmp/idento-backend .
      
      - name: Build agent
        run: cd agent && go build -v -o /tmp/idento-agent .
      
      - name: Summary
        run: |
          echo "## Go Build Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Backend and Agent built successfully" >> $GITHUB_STEP_SUMMARY
          ls -lh /tmp/idento-* >> $GITHUB_STEP_SUMMARY

  # TypeScript type checking
  typecheck-web:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.web == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json
      
      - name: Install dependencies
        run: cd web && npm ci
      
      - name: Type check
        run: cd web && npx tsc --noEmit
      
      - name: Summary
        if: always()
        run: |
          echo "## TypeScript Type Check Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Type checking completed" >> $GITHUB_STEP_SUMMARY

  # Lint web (ESLint)
  lint-web:
    name: Lint Web (ESLint)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.web == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json
      
      - name: Install dependencies
        run: cd web && npm ci
      
      - name: Lint with annotations
        run: cd web && npm run lint
      
      - name: Summary
        if: always()
        run: |
          echo "## ESLint Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Web linting completed" >> $GITHUB_STEP_SUMMARY

  # Build web
  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: [changes, typecheck-web, lint-web]
    if: needs.changes.outputs.web == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json
      
      - name: Install dependencies
        run: cd web && npm ci
      
      - name: Build
        run: cd web && npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: web/dist
          retention-days: 7
      
      - name: Summary
        run: |
          echo "## Web Build Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Web built successfully" >> $GITHUB_STEP_SUMMARY
          du -sh web/dist >> $GITHUB_STEP_SUMMARY

  # Lint Android (conditional, only for mobile changes)
  lint-android:
    name: Lint Android
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.mobile == 'true'
    continue-on-error: true  # Don't fail entire pipeline if Android lint fails
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
      
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            mobile/android-app/.gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('mobile/android-app/**/*.gradle*', 'mobile/android-app/gradle/wrapper/gradle-wrapper.properties', 'mobile/shared/**/*.gradle*') }}
          restore-keys: |
            gradle-${{ runner.os }}-
      
      - name: Grant execute permission
        run: chmod +x mobile/android-app/gradlew
      
      - name: Lint Android
        run: ./scripts/lint-mobile.sh
      
      - name: Summary
        if: always()
        run: |
          echo "## Android Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Android linting completed" >> $GITHUB_STEP_SUMMARY

  # Security: Dependency review for pull requests
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/dependency-review-action@v4
        with:
          comment-summary-in-pr: on-failure
          fail-on-severity: moderate
      
      - name: Summary
        if: always()
        run: |
          echo "## Dependency Security Review" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Dependency review completed" >> $GITHUB_STEP_SUMMARY

  # Final status check job that depends on all critical jobs
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint-go, test-go, build-go, typecheck-web, lint-web, build-web]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          # This job succeeds only if all needed jobs succeeded or were skipped
          if [[ "${{ needs.lint-go.result }}" != "success" && "${{ needs.lint-go.result }}" != "skipped" ]]; then
            echo "lint-go failed"
            exit 1
          fi
          if [[ "${{ needs.test-go.result }}" != "success" && "${{ needs.test-go.result }}" != "skipped" ]]; then
            echo "test-go failed"
            exit 1
          fi
          if [[ "${{ needs.build-go.result }}" != "success" && "${{ needs.build-go.result }}" != "skipped" ]]; then
            echo "build-go failed"
            exit 1
          fi
          if [[ "${{ needs.typecheck-web.result }}" != "success" && "${{ needs.typecheck-web.result }}" != "skipped" ]]; then
            echo "typecheck-web failed"
            exit 1
          fi
          if [[ "${{ needs.lint-web.result }}" != "success" && "${{ needs.lint-web.result }}" != "skipped" ]]; then
            echo "lint-web failed"
            exit 1
          fi
          if [[ "${{ needs.build-web.result }}" != "success" && "${{ needs.build-web.result }}" != "skipped" ]]; then
            echo "build-web failed"
            exit 1
          fi
          echo "âœ… All critical jobs passed!"
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸŽ‰ CI Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All required checks have passed!" >> $GITHUB_STEP_SUMMARY
